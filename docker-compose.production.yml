services:
  # BCV Service - Stateless microservice
  bcv-service:
    # IMPORTANTE: Usar imagen publicada de GitHub Container Registry
    # NO usar 'build: .' en producción
    image: ${DOCKER_IMAGE:-ghcr.io/emilioaray-dev/bcv-service:main}

    container_name: ${BCV_CONTAINER_NAME:-bcv-service}
    ports:
      - "${BCV_HOST_PORT:-3000}:${PORT:-3000}"

    # IMPORTANTE: Las variables sensibles se inyectan desde GitHub Secrets via SSH
    # NO usar env_file en producción para evitar secretos en el servidor
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=${PORT:-3000}
      - BCV_WEBSITE_URL=${BCV_WEBSITE_URL:-https://www.bcv.org.ve/}
      - CRON_SCHEDULE=${CRON_SCHEDULE:-0 * * * *}
      - SAVE_TO_DATABASE=${SAVE_TO_DATABASE:-true}
      - LOG_LEVEL=${LOG_LEVEL:-info}

      # Redis Cache Configuration
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_DB=${REDIS_DB:-0}
      - REDIS_MAX_RETRIES=${REDIS_MAX_RETRIES:-3}
      - REDIS_RETRY_DELAY=${REDIS_RETRY_DELAY:-1000}
      - REDIS_CONNECT_TIMEOUT=${REDIS_CONNECT_TIMEOUT:-10000}
      - CACHE_ENABLED=${CACHE_ENABLED:-true}
      - CACHE_TTL_LATEST=${CACHE_TTL_LATEST:-300}
      - CACHE_TTL_HISTORY=${CACHE_TTL_HISTORY:-86400}

      # MongoDB Atlas (Cloud) - Inyectado desde GitHub Secrets
      - MONGODB_URI=${MONGODB_URI}

      # Secretos - Inyectados desde GitHub Secrets (sin valores por defecto)
      - API_KEYS=${API_KEYS}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - WEBHOOK_URL=${WEBHOOK_URL}
      - DISCORD_WEBHOOK_URL=${DISCORD_WEBHOOK_URL}
      - SERVICE_STATUS_WEBHOOK_URL=${SERVICE_STATUS_WEBHOOK_URL}
      - DEPLOYMENT_WEBHOOK_URL=${DEPLOYMENT_WEBHOOK_URL}
      - SWAGGER_PROD_URL=${SWAGGER_PROD_URL}

    depends_on:
      redis:
        condition: service_healthy
    restart: ${RESTART_POLICY:-unless-stopped}
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:${PORT:-3000}/healthz"]
      interval: ${HEALTHCHECK_INTERVAL:-30s}
      timeout: ${HEALTHCHECK_TIMEOUT:-10s}
      retries: ${HEALTHCHECK_RETRIES:-3}
      start_period: ${HEALTHCHECK_START_PERIOD:-40s}
    networks:
      - bcv-network

  # Redis - Shared cache for stateless architecture
  redis:
    image: ${REDIS_IMAGE:-redis:7-alpine}
    container_name: ${REDIS_CONTAINER_NAME:-bcv-redis}
    command: >
      sh -c '
      if [ -n "$REDIS_PASSWORD" ]; then
        redis-server --requirepass "$REDIS_PASSWORD" --appendonly yes
      else
        redis-server --appendonly yes
      fi
      '
    ports:
      - "${REDIS_HOST_PORT:-6379}:${REDIS_PORT:-6379}"
    environment:
      - REDIS_PASSWORD=${REDIS_PASSWORD}
    volumes:
      - redis_data:/data
    restart: ${RESTART_POLICY:-unless-stopped}
    healthcheck:
      test: >
        sh -c '
        if [ -n "$REDIS_PASSWORD" ]; then
          redis-cli -a "$REDIS_PASSWORD" ping
        else
          redis-cli ping
        fi
        '
      interval: ${REDIS_HEALTHCHECK_INTERVAL:-10s}
      timeout: ${REDIS_HEALTHCHECK_TIMEOUT:-3s}
      retries: ${REDIS_HEALTHCHECK_RETRIES:-3}
      start_period: ${REDIS_HEALTHCHECK_START_PERIOD:-10s}
    networks:
      - bcv-network

volumes:
  redis_data:
    driver: local

networks:
  bcv-network:
    driver: bridge
