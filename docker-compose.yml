version: '3.8'

services:
  # BCV Service - Stateless microservice
  bcv-service:
    # Opción 1: Usar imagen publicada en GitHub Container Registry (PRODUCCIÓN)
    # Descomenta la siguiente línea para usar la imagen publicada
    # Por defecto usa tag "latest", pero puedes especificar versión: 1.0.2, 1.0, 1
    # image: ${DOCKER_IMAGE:-ghcr.io/emilioaray-dev/bcv-service:latest}

    # Opción 2: Construir localmente (DESARROLLO)
    # Comenta esta línea en producción
    build: .

    container_name: ${BCV_CONTAINER_NAME:-bcv-service}
    ports:
      - "${BCV_HOST_PORT:-3000}:${PORT:-3000}"

    # Cargar todas las variables de entorno desde el archivo .env
    env_file:
      - .env

    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=${PORT:-3000}
      - BCV_WEBSITE_URL=${BCV_WEBSITE_URL:-https://www.bcv.org.ve/}
      - CRON_SCHEDULE=${CRON_SCHEDULE:-0 * * * *}
      - SAVE_TO_DATABASE=${SAVE_TO_DATABASE:-true}
      - LOG_LEVEL=${LOG_LEVEL:-info}

      # Redis Cache Configuration
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      - REDIS_DB=${REDIS_DB:-0}
      - REDIS_MAX_RETRIES=${REDIS_MAX_RETRIES:-3}
      - REDIS_RETRY_DELAY=${REDIS_RETRY_DELAY:-1000}
      - REDIS_CONNECT_TIMEOUT=${REDIS_CONNECT_TIMEOUT:-10000}
      - CACHE_ENABLED=${CACHE_ENABLED:-true}
      - CACHE_TTL_LATEST=${CACHE_TTL_LATEST:-300}
      - CACHE_TTL_HISTORY=${CACHE_TTL_HISTORY:-86400}

      # Opción 1: Usar Docker Secrets (recomendado para producción)
      # Descomenta las siguientes líneas y comenta las variables directas si usas secrets
      # - MONGODB_URI_FILE=/run/secrets/mongodb_uri
      # - API_KEYS_FILE=/run/secrets/api_keys
      # - REDIS_PASSWORD_FILE=/run/secrets/redis_password

      # Opción 2: Variables de entorno directas (desarrollo/testing)
      # Comenta estas líneas si usas Docker Secrets

      # MongoDB Atlas (Cloud) - Toma del archivo .env
      - MONGODB_URI=${MONGODB_URI}

      # MongoDB Local (comentado - solo para desarrollo local)
      # - MONGODB_URI=mongodb://bcv_user:bcv4r4y4r4y@mongo:27017/bcvdb?authSource=bcvdb

      # Optional: API Keys for authentication (comma-separated)
      - API_KEYS=${API_KEYS:-}

      # Optional: Webhook URLs for notifications
      - WEBHOOK_URL=${WEBHOOK_URL:-}
      - DISCORD_WEBHOOK_URL=${DISCORD_WEBHOOK_URL:-}

      # Optional: Swagger production server URL
      - SWAGGER_PROD_URL=${SWAGGER_PROD_URL:-}

    # Descomenta la siguiente sección si usas Docker Secrets
    # secrets:
    #   - mongodb_uri
    #   - api_keys
    #   - redis_password

    depends_on:
      # MongoDB local (comentado porque usamos MongoDB Atlas)
      # mongo:
      #   condition: service_healthy
      redis:
        condition: service_healthy
    restart: ${RESTART_POLICY:-unless-stopped}
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:${PORT:-3000}/healthz"]
      interval: ${HEALTHCHECK_INTERVAL:-30s}
      timeout: ${HEALTHCHECK_TIMEOUT:-10s}
      retries: ${HEALTHCHECK_RETRIES:-3}
      start_period: ${HEALTHCHECK_START_PERIOD:-40s}
    networks:
      - bcv-network

  # Redis - Shared cache for stateless architecture
  redis:
    image: ${REDIS_IMAGE:-redis:7-alpine}
    container_name: ${REDIS_CONTAINER_NAME:-bcv-redis}
    command: >
      sh -c '
      if [ -n "$REDIS_PASSWORD" ]; then
        redis-server --requirepass "$REDIS_PASSWORD" --appendonly yes
      else
        redis-server --appendonly yes
      fi
      '
    ports:
      - "${REDIS_HOST_PORT:-6379}:${REDIS_PORT:-6379}"
    environment:
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
    volumes:
      - redis_data:/data
    restart: ${RESTART_POLICY:-unless-stopped}
    healthcheck:
      test: >
        sh -c '
        if [ -n "$REDIS_PASSWORD" ]; then
          redis-cli -a "$REDIS_PASSWORD" ping
        else
          redis-cli ping
        fi
        '
      interval: ${REDIS_HEALTHCHECK_INTERVAL:-10s}
      timeout: ${REDIS_HEALTHCHECK_TIMEOUT:-3s}
      retries: ${REDIS_HEALTHCHECK_RETRIES:-3}
      start_period: ${REDIS_HEALTHCHECK_START_PERIOD:-10s}
    networks:
      - bcv-network

  # MongoDB - Database for exchange rate history
  # COMENTADO: Usamos MongoDB Atlas (Cloud) en lugar de MongoDB local
  # mongo:
  #   image: mongo:7
  #   container_name: bcv-mongo
  #   ports:
  #     - "27017:27017"
  #   environment:
  #     - MONGO_INITDB_ROOT_USERNAME=admin
  #     - MONGO_INITDB_ROOT_PASSWORD=admin123
  #     - MONGO_INITDB_DATABASE=bcvdb
  #   volumes:
  #     - mongo_data:/data/db
  #     - ./scripts/mongo-init.js:/docker-entrypoint-initdb.d/mongo-init.js:ro
  #   restart: unless-stopped
  #   healthcheck:
  #     test: >
  #       mongosh --quiet --eval "
  #       try {
  #         db.adminCommand('ping');
  #         print('MongoDB is ready');
  #       } catch (err) {
  #         print('MongoDB is not ready');
  #         quit(1);
  #       }
  #       "
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5
  #     start_period: 30s
  #   networks:
  #     - bcv-network

volumes:
  redis_data:
    driver: local
  # mongo_data:  # COMENTADO: No se usa MongoDB local
  #   driver: local

networks:
  bcv-network:
    driver: bridge

# Descomenta esta sección si usas Docker Secrets
# secrets:
#   mongodb_uri:
#     file: ./secrets/mongodb_uri.txt
#   api_keys:
#     file: ./secrets/api_keys.txt
#   redis_password:
#     file: ./secrets/redis_password.txt